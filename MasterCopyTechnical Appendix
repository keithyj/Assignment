---
title: "???????"
author: "Group 6"
date: "12/02/2022"
output: 
  pdf_document:
  fontsize: 11pt
  geometry: margin = 1in
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height = 10,
	fig.width = 15,
	message = FALSE,
	include = TRUE,
	warnings = FALSE
)
```

```{r packages, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# First we load the dataset and required libraries
load("~/Downloads/cancer.RData")
library(VIM)
library(GGally)
library(usmap)
library(car)
library(stringr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(dlookr)
```

### LOOKING AT DEATH RATE IN THE USA
```{r, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
cancer3 <- cancer
uwu2 <- str_split(cancer3$Geography, pattern = ", ")
cancer3$state <- rep(0, length(cancer3$Geography))
for(i in 1:length(cancer3$Geography)){
  cancer3$state[i] <- uwu2[[i]][2]
}
cancer3$county <- rep(0, length(cancer3$Geography))
for(i in 1:length(cancer3$Geography)){
  cancer3$county[i] <- uwu2[[i]][1]
}
cancer3$county[167] <- "Dona Ana County"
cancer3$county[821] <- "La Salle Parish"
cancer3$fips <- rep("0", length(cancer3$Geography))
for(i in 1:length(cancer3$Geography)){
  cancer3$fips[i] <- fips(cancer3$state[i], cancer3$county[i])
}
deathMap <- subset(cancer3, select = c("fips", "county", "deathRate"))
plot_usmap(data = deathMap,regions = "counties", values = "deathRate", include = cancer3$fips, color = "red") +
  scale_fill_continuous(low = "yellow", high = "red", name = "Death Rate", label = scales::comma) +
  labs(title = "Death rates in the states") +
  theme(legend.position = "right")
```

The map above gives a nice illustration of what death rate looks like accross the United States, whites indicate that county was missing from the original dataset.


```{r strange, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
sus <- subset(cancer, AvgHouseholdSize < 0.5)
head(sus)
```

I will use an alternate source to check if the AvgHousehold Size is correct for Berkeley County.

```{r Berk, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
sus[1,"AvgHouseholdSize"]
```

Reference:
https://data.census.gov/cedsci/table?q=average%20household%20size&g=0500000US54003&y=2013&tid=ACSST1Y2013.S1101

From the same census data we have that the average household size of this county is 2.61. This indicates the data has been incorrectly 
inputted into this dataset or the data is missing. Either way, this incorrect data could cause the distribution to be unstable and should be considered as missing.

## Summary

First lets have a look at a summary of all the data:

```{r summary, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
summary(cancer)
cancer1 <- cancer
susPoint <- which(cancer1$AvgHouseholdSize < 0.5)
cancer1$AvgHouseholdSize[susPoint] <- NA
summary(cancer1)
DF<-cancer[,c(5, 12:14)]
```
## Missing Values and Strange Values:

```{r}
load("cancer.rdata")
summary(cancer)
```

There are some missing values in PctEmployed16_Over which need to be checked.
Before that is checked though we should note that the outliers in AvgHouseholdSize should be treated as missing values as they are wrongly inputted (reference).

```{r}
cancer1 <- cancer
cancer1$AvgHouseholdSize[cancer1$AvgHouseholdSize < 0.5] <- NA
```

Now I use the VIM package and the pbox() function to show that the missing data are all MCAR and can thus be easily dealt with.

```{r, message = FALSE}
library(VIM)
par(mfrow = c(1,4))
for(i in 2:5){
  pbox(cancer1, pos = i)
}
```

```{r}
par(mfrow = c(1,4))
for(i in 6:9){
  pbox(cancer1, pos = i)
}
```


```{r}
par(mfrow = c(1,4))
for(i in 10:13){
  pbox(cancer1, pos = i)
}
```

```{r}
par(mfrow = c(1,5))
for(i in 14:18){
  pbox(cancer1, pos = i)
}
```

From the pbox plots we have evidence that the missing values interrogated are MCAR. Since the proportion of rows with missing values is small I recommend simply deleting the rows with missing values as it should not affect the validity of our analysis on the whole dataset as the smaller sample is still representative.

```{r}
cancer2 <- na.omit(cancer1)
```

Our other option is to use the reference to fill in all our other missing values. Despite this being possible it is also un-necessary as the data is MCAR and won't significantly affect our analysis.

We notice that there is one categorical variable (binnedInc) and one ID variable (Geography). Geography shouldn't be used as an explanatory variable but could be used as a visual aid.

We also note that PctEmployed16_Over has 152 missing values that should be investigated.

## Univariate Plots:

```{r uni, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
#Alex
par(mfrow = c(2,2))
hist(cancer$AvgHouseholdSize)
hist(cancer$PctEmployed16_Over)
hist(cancer$PctBlack)
hist(cancer$PctUnemployed16_Over)
DF %>% gather() %>%
  ggplot(aes(x = value)) + facet_wrap(~key, scales = "free") +
  geom_histogram(col = c("blue"), fill = "blue", alpha=0.6)
hist(cancer2$medIncome)
hist(cancer2$MedianAgeFemale)
hist(cancer2$MedianAgeMale)
par(mfrow=c(2,1))
hist(cancer2$incidenceRate, breaks = 30, main = "Histogram of Incidence Rate")
plot(density(cancer2$incidenceRate), main= "Density estimate of Incidence Rate") 

par(mfrow=c(2,1))
hist(cancer2$PercentMarried, breaks = 30, main = "Histogram of Percent Married")
plot(density(cancer2$PercentMarried), main="Density estimate of Percent Married") 

par(mfrow=c(2,1))
hist(cancer2$PctMarriedHouseholds, breaks = 30, main = "Histogram of PctMarriedHouseholds")
plot(density(cancer2$PctMarriedHouseholds), main="Density estimate of PctMarriedHouseholds")

par(mfrow=c(2,1))
hist(cancer2$Edu18_24, breaks = 30, main = "Histogram of Edu18_24")
plot(density(cancer2$Edu18_24), main="Density estimate of Edu18_24")
# We note that incidence rate shows a severe postive skew. 
# We need to fix the skewness by considering a possible logarithmic transformation. 
# PercentMarried also shows moderate negative skewness. We can fix this using square transformation for negatively skewed data.

#medIncome seem to have a right skew, more skew than any others.
# We note that PctBlack has very large right skew and will need transforming to fix this.
# We also note that there are some very suspicious low values in AvgHouseholdSize which are outliers. We create a new dataset containing these suspicious values.
# We can see that the three Coverage variables are symmetrical but povertyPercent is right-skewed.
# A transformation is needed to tackle this skewness.

```

## Comparing Predictors and Response

```{r, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
#NEED TO LOOK AT WHICH OTHER VARIABLES HAVE A CORRELATION
ggpairs(cancer2, columns = c(2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18), mapping = aes(alpha = 0.6),
        upper = list(continuous=wrap("cor", size=2.5, digits=2, stars=FALSE)),
        lower = list(continuous=wrap("points", size = 0.5)),
        diag = list(continuous="densityDiag"),
        progress = FALSE) +
  theme(text=element_text(size=6))
  
plot_correlate(cancer2)
  
#medIncome is right skewed, can do a transformation on this
#MedianAgeFemale and MedianAgeMale are heavily positively correlated
#No clue what is happening with the binned income might be worth doing this plot without binned income and doing that as a seperate thing to then do the correlaiton as it is hard to see the intervals
#Death rate and median age has almost no correlation.
#Variance inflation factors to look at binnedincome and median income - if high, multicollinearity exists and we can argue to get rid of it.

#povertyPercent, PctPrivateCoverage, PctEmpCoverage, PctPublicCoverage: The three coverage variables are highly correlated as expected. However, the deathRate is not significantly correlated to any of the coverage variables.
#The correlation coefficicent between deathRate and the coverage variables do not exceed 0.45.

# Unemployed and Employed 16 or over have high correlation with each other.

# PercentMarried and PctMarriedHouseholds are also highly correlated. 

#We haven't looked at all together so there might be some new correlations.
```

Below we have some plots of our variables against death rate:

```{r Plot Death, echo = FALSE, fig.cap = "\\label{fig:figs}Predictors vs Death Plots", eval = TRUE, warning = FALSE, message = FALSE}
par(mfrow = c(2,2))
plot(deathRate~AvgHouseholdSize, data = cancer2)
plot(deathRate~PctEmployed16_Over, data = cancer2)
plot(deathRate~PctUnemployed16_Over, data = cancer2)
plot(deathRate~PctBlack, data = cancer2)
plot(deathRate~medIncome, data = cancer2)
plot(deathRate~MedianAgeFemale, data = cancer2)
plot(deathRate~MedianAgeMale, data = cancer2)
plot(deathRate~povertyPercent, data = cancer2)
plot(deathRate~PctPrivateCoverage, data = cancer2)
plot(deathRate~PctEmpPrivCoverage, data = cancer2)
plot(deathRate~PctPublicCoverage, data = cancer2)
plot(deathRate~incidenceRate, data = cancer2)
plot(deathRate~PercentMarried, data = cancer2)
plot(deathRate~PctMarriedHouseholds, data = cancer2)
plot(deathRate~Edu18_24, data = cancer2)

```

## Transformation in Skew
```{r fix skew, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# Try cube rooting for poverty.
DF$povertyFIX <- (DF$povertyPercent)^(1/3)
ggplot(DF, aes(povertyFIX))+geom_density()
```

```{r fix skew, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# Try log for medincome.
cancer2$medIncomeFix <- log(cancer2$medIncome)
ggplot(cancer2, aes(medIncomeFix))+geom_density()
```

```{r Fixing Black, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# PctBlack is incredibly right skewed, we can try a log transformation to fix it. 
cancer2$blackFix <- log(cancer2$PctBlack)
ggplot(cancer2, aes(blackFix)) + geom_density()
```

```{r Fix Unemployment, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# PctUnemployed16_Over is also slightly right skewed. We can try a square root transformation to fix this.
cancer2$UnempFix <- sqrt(cancer2$PctUnemployed16_Over)
ggplot(cancer2, aes(UnempFix)) + geom_density()
```

```{r Size Fix, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# Average household size maybe needs fixing
cancer2$Avgfix <- log(cancer2$AvgHouseholdSize)
ggplot(cancer2, aes(Avgfix)) + geom_density()
```

```{r transformation, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# Try fixing incidence rate and percent married
cancer2$incidenceRate <- log(cancer2$incidenceRate)
hist(cancer2$incidenceRate, main = "Histogram of Transformed Incidence Rate")
plot(density(cancer2$incidenceRate), main= "Density estimate of Transformed Incidence Rate")

cancer2$PercentMarried<- cancer2$PercentMarried^(2)
hist(cancer2$PercentMarried, breaks = 30, main = "Histogram of transformed Percent Married")
plot(density(cancer2$PercentMarried), main="Density estimate of transformed Percent Married")
# The transformed predictor variables, ie, Incidence Rate and PercentMarried, now have a normal spread and therefore skewness is fixed.
```


We have evidence of multicolinearity between Unemployment and Employment.

## HETEROSCEDASTICITY

```{r Residual Plots, echo = FALSE, fig.cap = "\\label{fig:figs}Residual Plots", eval = TRUE, warning = FALSE, message = FALSE}
par(mfrow = c(2,2))
plot(lm(deathRate~AvgHouseholdSize, data = cancer2), 1)
plot(lm(deathRate~PctUnemployed16_Over, data = cancer2), 1)
plot(lm(deathRate~PctEmployed16_Over, data = cancer2), 1)
plot(lm(deathRate~PctBlack, data = cancer2), 1)
# We have evidence of a lot of heteroscedasticity for PctBlack, we can use a spread level plot for a suggested transformation

modIncome <- lm(deathRate~medIncome, data = cancer2)
modMale <- lm(deathRate~MedianAgeMale, data = cancer2)
modFemale <- lm(deathRate~MedianAgeFemale, data = cancer2)
modbinnedInc <- lm(deathRate~binnedInc, data = cancer2)
par(mfrow = c(2,2))
plot(modIncome, 1)
plot(modMale, 1)
plot(modFemale, 1)
plot(modbinnedInc, 1)
# Potential heteroscedasicity for medIncome, no signs for the others.
# Need to deal with heteroscaedscatic, use a spread level plot


par(mfrow=c(2,2))
plot(lm(deathRate~povertyPercent, data = cancer2), 1)
title(sub="PovertyPercent")
plot(lm(deathRate~PctPrivateCoverage, data = cancer2), 1)
title(sub="PctPrivateCoverage")
plot(lm(deathRate~PctEmpPrivCoverage, data = cancer2), 1)
title(sub="PctEmpPrivCoverage")
plot(lm(deathRate~PctPublicCoverage, data = cancer2), 1)
title(sub="PctPublicCoverage")
# There is potential heteroscedascity in PctEmpPrivCoverage
```
```{r residual plots, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
par(mfrow=c(2,2))
plot(lm(deathRate~incidenceRate, data = cancer2),1)
plot(lm(deathRate~PercentMarried, data = cancer2),1)
plot(lm(deathRate~PctMarriedHouseholds, data = cancer2),1)
plot(lm(deathRate~Edu18_24, data = cancer2),1)
# There is possible heteroscedasticity for Incidence Rate and Edu18_24. Can use spreadlevelplot to fix heteroscedasticity.
```

## TESTING HETEROSCEDACITY
```{r Spread Level, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
spreadLevelPlot(lm(deathRate~PctBlack, data = cancer2))
ncvTest(lm(deathRate~PctBlack, data = cancer2))

ncvTest(lm(deathRate~PctEmpPrivCoverage, data = cancer2))
spreadLevelPlot(lm(deathRate~PctEmpPrivCoverage, data = cancer2))

ncvTest(lm(deathRate~medIncome, data = cancer2))
spreadLevelPlot(lm(deathRate~medIncome, data = cancer2))

ncvTest(lm(deathRate~PctEmployed16_Over, data = cancer2))
spreadLevelPlot(lm(deathRate~PctEmployed16_Over, data = cancer2))

ncvTest(lm(deathRate~incidenceRate, data=cancer2))
spreadLevelPlot(lm(deathRate~incidenceRate, data = cancer2))

ncvTest(lm(deathRate~Edu18_24, data=cancer2))
spreadLevelPlot(lm(deathRate~Edu18_24, data = cancer2))

```
## FIXING HETEROSCEDASCITY

```{r hetroscedascity fix, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# Try power=5
plot(lm(deathRate^(5)~PctEmpPrivCoverage, data = cancer2),1)
ncvTest(lm(deathRate^5~PctEmpPrivCoverage, data = cancer2))

# We try cubing the response to fix the heteroscedasticity

plot(lm(deathRate^3~PctBlack, data = cancer2), 1)
spreadLevelPlot(lm(deathRate^3~PctBlack, data = cancer2))

# This seems to have mostly fixed heteroscedasticity

# This is a different transformation than the one used to fix the density though

# There is also some heteroscedasticity present for employed 16 or over.


# Fixing employed over 16
plot(lm(deathRate^(-2)~PctEmployed16_Over, data = cancer2), 1)
spreadLevelPlot(lm(deathRate^(-2)~PctEmployed16_Over, data = cancer2))
```

``` {r something, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# Stabilise spread and fix heterscedasticity
#Try power=1.5
plot(lm(deathRate^(1.5)~incidenceRate, , data = cancer2))
#Try power= -3
plot(lm(deathRate^(-3)~Edu18_24, , data = cancer2),1)
```

## Multicolinearity


```{r Multi, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
# We have high correlation between employed 16 and over and unemployed 16 and over. We will test to see if both are necessary.

vif(lm(deathRate~PctEmployed16_Over + PctUnemployed16_Over, data = cancer2))

# Variance inflation factors are low though, so we could potentially use both as they aren't measuring the exact same thing.

vif(lm(deathRate~PctPrivateCoverage+PctEmpPrivCoverage+ PctPublicCoverage, data = cancer2))
vif(lm(deathRate~PctPrivateCoverage+PctEmpPrivCoverage+ PctPublicCoverage+ povertyPercent, data = cancer2))
# Although VIF are not very big,the three healthcare coverage variables are clearly correlated.
# I would discard PctPrivateCoverage and PctEmpPrivCoverage in fitting a model.
# I leave PctPublicCoverage because it is the least correlated variable with povertyPercent among the healthcare coverage variables.
vif(lm(deathRate~binnedInc + medIncome, data = cancer2))
```

```{r multicollinearity, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
vif(lm(deathRate~incidenceRate+PercentMarried+Edu18_24, data=cancer2))

vif(lm(deathRate~incidenceRate+PercentMarried+PctMarriedHouseholds+Edu18_24, data=cancer2))


# PercentMarried and PctMarriedHouseholds are clearly highly correlated. 

# Therefore, I would suggest that it is best to leave out PctMarriedHouseholds to reduce multicollinearity in the model. 
```
```{r Binned Check, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
vif(lm(deathRate~binnedInc + medIncome, data = cancer2))
# Highly correlated, best to leave out binnedIncome
vif(lm(deathRate~MedianAgeMale + MedianAgeFemale, data = cancer2))
# Highly correlated, best to take an average and have just one variable as MedianAge
```


## OUTLIERS
First we use box-plots to see if there are any suspicous value.
```{r outlier, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
ggplot(cancer2, aes(medIncome)) + geom_boxplot()
ggplot(cancer2, aes(MedianAgeMale)) + geom_boxplot()
ggplot(cancer2, aes(MedianAgeFemale)) + geom_boxplot()
ggplot(cancer2, aes(binnedInc)) + geom_boxplot()
ggplot(cancer2, aes(PctBlack)) + geom_boxplot()
ggplot(cancer2, aes(AvgHouseholdSize)) + geom_boxplot()
ggplot(cancer2, aes(PctUnemployed16_Over)) + geom_boxplot()
ggplot(cancer2, aes(PctEmployed16_Over)) + geom_boxplot()
```
```{r boxplot, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}

DF %>% gather() %>%
  ggplot(aes(x = value)) + facet_wrap(~key, scales = "free") +
  geom_boxplot(shape=1, alpha=0.3)
# From the box-plots, all four variables have a quite a big number of extreme values. We need further investigations.
```


```{r outliers, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
ggplot(cancer2, aes(incidenceRate)) + geom_boxplot()
ggplot(cancer2, aes(PercentMarried)) + geom_boxplot()
ggplot(cancer2,aes(PctMarriedHouseholds)) + geom_boxplot()
ggplot(cancer2, aes(Edu18_24)) + geom_boxplot()

# We observe that the  outliers are present for all predictor variables. 

# The boxplot for Incidence rate shows the existence of extreme high values. 

# Therefore, we might want to investigate into the outliers of incidence rate only and decide how we might want to treat them. 

# Possible options include deleting the outliers or imputing them. 

# This might depend on whether the outlier is due to some error (data entry, sampling, measurement) or whether the outlier is natural. 
```


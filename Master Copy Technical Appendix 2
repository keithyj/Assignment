---
title: "ST404 Assignment 1 Alex"
output: pdf_document
urlcolor: blue
fontsize: 11pt
geometry: margin = 1in
fig_caption: yes
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
load("cancer.rdata")
library(VIM)
library(GGally)
library(usmap)
library(car)
library(stringr)
library(knitr)
library(tidyr)  
```

# ST404 Assignment 1 Alex

## Checking the summary and initial EDA

\scriptsize

```{r Summary, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
summary(cancer)
```

\normalsize

There are some missing values in PctEmployed16_Over which need to be checked.

The minimum value in AvgHouseholdSize is very small which is suspicious and should be immediately investigated.

```{r Sus Plot, echo = FALSE, fig.cap = "\\label{fig:figs}deathRate vs AvgHouseholdSize", fig.width=5, fig.asp=0.68, fig.align="center", eval = TRUE, message = FALSE, warning = FALSE}
plot(deathRate ~ AvgHouseholdSize, data = cancer, main = "deathRate against AvgHouseholdSize")
```

From the above plot we note that there are many extremely suspicious points with small AvgHouseholdSize.

We identify one of these points and investigate it:

```{r Extracting suspicious point, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
kable(subset(cancer, AvgHouseholdSize < 0.5)[1,c("Geography", "AvgHouseholdSize")])
```

To check the validity of this data point we find an alternate source of the data at:

https://data.census.gov/cedsci/table?q=average%20household%20size&g=0500000US54003&y=2013&tid=ACSST1Y2013.S1101

We note that this data recording AvgHouseholdSize in the same year as our data lists the size at 2.61. This is completely different and this is similar for other small values in our dataset.

Hence, these are very likely incorrectly inputted data points and as there is only a small proportion of them we should treat them as missing data and then test to see whether they are MCAR.

```{r Replace small with NA, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
cancer1 <- cancer
cancer1$AvgHouseholdSize[which(cancer1$AvgHouseholdSize < 0.5)] <- NA
```

## Missing values check

Now that we have replaced the small values with NAs we can test the data to see what kind of missing values we have.

```{r Miss, fig.cap = "\\label{fig:figs}Pbox plots showing difference between missing and non-missing data", results = "asis", fig.align = "center", fig.height = 3, fig.width = 7, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
par(mfrow = c(1,4))
for (i in c(2:4, 18)){ 
  pbox(cancer1,pos=i) 
}
```

We use the pbox() function from the VIM package to check what these missing values represent.

From the above plots we note that the box plots with the missing data do not look significantly different from those without. The pbox plots for the other variables look similar to this so we conclude that the data that is missing is MCAR.

With our data we could replace all the data with an alternate source but as the proportion of missing data points is so small and it is MCAR it is safe to just remove the rows with missing data from our data set.

```{r remove miss, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
cancer2 <- na.omit(cancer1)
```


- GG pairs analysis 

We can see initially that medIncome is right skewed, also median age Male and Female are highly correlated. We will use a pearsons coefficient to check if multicollinearity exist (http://www.sthda.com/english/wiki/correlation-test-between-two-variables-in-r). 
binnedInc does not tell us much from this graph - we will instead look at binnedInc and medIncome together as they measure similar data to check for multicollinearity. 

### Histograms

Massive right skew for pctBlack. PctUnemployed and AvgHouseholdSize are also a little right skew.
I Recommend a log transform for pctBlack and sqrt transforms for pct unemployed and avg household size.

```{r Transforms, fig.cap = "\\label{fig:figs}Our transformed histograms", fig.width=5, fig.asp=0.68, fig.align="center", echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
par(mfrow = c(1,3))
with(cancer2, hist(sqrt(AvgHouseholdSize), main = "Transformed AvgHouseholdSize"))
with(cancer2, hist(sqrt(PctUnemployed16_Over), main = "Transformed PctUnemployed16_Over"))
with(cancer2, hist(log(cancer2$PctBlack), main = "Transformed PctBlack"))
```

```{r histograms james, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
par(mfrow = c(3,3))
with(cancer2, hist(medIncome))
with(cancer2, hist(MedianAgeFemale))
with(cancer2, hist(MedianAgeMale))
hist(cancer2$incidenceRate, breaks = 30, main = "Histogram of Incidence Rate")
hist(cancer2$PercentMarried, breaks = 30, main = "Histogram of Percent Married")
hist(cancer2$PctMarriedHouseholds, breaks = 30, main = "Histogram of PctMarriedHouseholds")
hist(cancer2$Edu18_24, breaks = 30, main = "Histogram of Edu18_24")
with(cancer2, hist(AvgHouseholdSize))
with(cancer2, hist(PctEmployed16_Over))
with(cancer2, hist(PctUnemployed16_Over))
with(cancer2, hist(PctBlack))
with(cancer2, hist(deathRate))
hist(cancer2$povertyPercent, breaks = 30, main = "Histogram of povertyPercent")
hist(cancer2$PctPrivateCoverage, breaks = 30, main = "Histogram of PctPrivateCoverage")
hist(cancer2$PctEmpPrivCoverage, breaks = 30, main = "Histogram of PctEmpPrivCoverage")
hist(cancer2$PctPublicCoverage, breaks = 30, main = "Histogram of PctPublicCoverage")
```
Massive right skew for medIncome. Median age Male and Female seem to have a pretty symettrical skew.
I recommend a log transform for medIncome.

From the histograms, PctPrivateCoverage is slightly left skewed and povertyPercent
is right skewed.
Transformations are needed.
Try cube root for povertyPercent.

```{r Transforms, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
par(mfrow = c(1,3))
hist(log(cancer2$medIncome), main = "Transformed medIncome")
hist(cancer2$povertyPercent^(1/3), breaks = 30, main = "Histogram of cube root of povertyPercent")
hist(cancer2$PctPrivateCoverage^(2), breaks = 30, main = "Histogram of square of PctPrivateCoverage")
```

There still exists a slight right skew for medIncome but it is an improvement.

The skewness in povertyPercent is removed in the cubeth rooting transfomation.

The skewness is in PctPrivateCoverage is removed by the square transformation.


## Bivariate Plots
### Plots Against Death Rate
```{r Plots against deathRate, fig.cap = "\\label{fig:figs}Plots showing deathRate against other variables", fig.width=5, fig.asp=1, fig.align="center", echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
par(mfrow = c(3,3))
with(cancer2, scatter.smooth(deathRate~AvgHouseholdSize, col = "red"))
with(cancer2, scatter.smooth(deathRate~PctEmployed16_Over, col = "red"))
with(cancer2, scatter.smooth(deathRate~PctUnemployed16_Over, col = "red"))
with(cancer2, scatter.smooth(deathRate~PctBlack, col = "red"))
scatter.smooth(cancer2$incidenceRate, cancer2$deathRate, lpars=list(col = "blue", lwd = 2), ylab="deathRate",xlab="Incidence Rate")
scatter.smooth(cancer2$PercentMarried, cancer2$deathRate, lpars=list(col = "blue", lwd = 2),
ylab="deathRate", xlab="Percent Married")
scatter.smooth(cancer2$PctMarriedHouseholds, cancer2$deathRate, lpars=list(col = "blue", lwd = 2),
ylab="deathRate",xlab="PctMarriedHouseholds")
scatter.smooth(cancer2$Edu18_24, cancer2$deathRate, lpars=list(col = "blue", lwd = 2),
ylab="deathRate",xlab="Edu18_24")
scatter.smooth(cancer2$medIncome, cancer2$deathRate, lpars=list(col = "blue", lwd = 2), ylab="deathRate", xlab="Median Income")
scatter.smooth(cancer2$MedianAgeFemale, cancer2$deathRate, lpars=list(col = "blue", lwd = 2), ylab="deathRate", xlab="Median Age Female")
scatter.smooth(cancer2$MedianAgeMale, cancer2$deathRate, lpars=list(col = "blue", lwd = 2), ylab="deathRate", xlab="Median Age Female")
scatter.smooth(cancer2$binnedInc, cancer2$deathRate, lpars=list(col = "blue", lwd = 2), ylab="deathRate", xlab="Income (Binned)")
scatter.smooth(cancer2$povertyPercent, cancer2$deathRate, lpars=list(col = "red", lwd = 2), ylab="deathRate",xlab="povertyPercent")
scatter.smooth(cancer2$PctPrivateCoverage, cancer2$deathRate, lpars=list(col = "red", lwd = 2),
ylab="deathRate", xlab="PctPrivateCoverage")
scatter.smooth(cancer2$PctPublicCoverage, cancer2$deathRate, lpars=list(col = "red", lwd = 2),
ylab="deathRate",xlab="PctPublicCoverage")
scatter.smooth(cancer2$PctEmpPrivCoverage, cancer2$deathRate, lpars=list(col = "red", lwd = 2),
ylab="deathRate",xlab="PctEmpPrivCoverage")
```

From the bivariate plots there is definite heteroskedasticity in pctBlack and for AvgHouseholdSize we see some non linearity. We see a concave shape so advising a more compex model, perhaps with a quadratic term might be advisable as the data is not monotonic.

There is definite heteroscedasticity in medIncome and for both MedianAgeFemale and MedianAgeMale we see some non linearity. We see a concave shape so advising a more compex model, perhaps with a quadratic term might be advisable as the data is not monotonic. We could also consider combining the two variables by taking an average as their relationship with Death Rate are very similar. BinnedInc does not show us much other than it is linear.

From the scatter plots there are no clear outliers.

From the bivariate plots there is definite heteroskedasticity in pctBlack and for AvgHouseholdSize we see some non linearity. We see a concave shape so advising a more complex model, perhaps with a quadratic term might be advisable as the data is not monotonic.

For heteroskedasticity we would need to perform further tests after fititng a model to check what kind of transformation we'd need to fix it.

From the scatter plots there are no clear outliers, we'd need either some box plots or to look at cook's distance to identify that.

From the scatterplots, the predictor variables show a fairly linear relationship with death Rate. 
The fitted lines for PercentMarried, PctMarriedHouseholds and Edu18_24 show an inverse relationship with the response variable. 
However,the fitted line for incidence rate indicates that the outliers might have a high influence on the model and therefore we can observe that there is heteroscedasticity.
We need to perform further investigation and tests after fitting a model and we can use spreadLevelPlot() to fix heteroscedasticity.  

We can see all four variables have fairlty straight fitted lines. This support
them being linear.
The data points of PctEmpPrivCoverage are getting closer to the fitted line
which shows that the variance is decreasing.
We might use spreadLevelPlot() to find appropriate power transformation to fix
this problem.

### Plots for Outliers
```{r BoxPlots, fig.cap = "\\label{fig:figs}BoxPlots of our variables", fig.align="center", echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
par(mfrow = c(2,3))
with(cancer2, boxplot(AvgHouseholdSize, main = "AvgHouseholdSize"))
with(cancer2, boxplot(PctEmployed16_Over, main = "PctEmployed16_Over"))
with(cancer2, boxplot(PctUnemployed16_Over, main = "PctUnemployed16_Over"))
with(cancer2, boxplot(PctBlack, main = "PctBlack"))
with(cancer2, boxplot(deathRate, main = "deathRate"))
with(cancer2, boxplot(medIncome, main = "medIncome"))
with(cancer2, boxplot(MedianAgeFemale, main = "MedianAgeFemale"))
with(cancer2, boxplot(MedianAgeMale, main = "MedianAgeMale"))
with(cancer2, boxplot(binnedInc, main = "binnedInc"))
ggplot(cancer2, aes(incidenceRate)) + geom_boxplot()
ggplot(cancer2, aes(PercentMarried)) + geom_boxplot()
ggplot(cancer2,aes(PctMarriedHouseholds)) + geom_boxplot()
ggplot(cancer2, aes(Edu18_24)) + geom_boxplot()
```
Our box plots show we have quite a number of what we would consider outliers accross all our variables apart from binnedInc, which would be impossible due to the bins intervals. This does not necessarily mean that they should be removed as we do not know their influence yet due to not fitting a model.

We have a severe amount of outliers in medIncome. This is most likely due to natural causes such as a CEO of a large company or a doctor (Reference needed about high paid jobs). 

 This does not necessarily mean that they should be removed as we do not know their influence yet due to not fitting a model.

We have a severe amount of outliers in PctBlack according to our box plot. This could be due to the very long tail as shown in the scatter plot above.

The boxplot for Incidence rate shows the existence of extreme high values. 

Therefore, we might want to investigate into the outliers of the predictor variables and decide how we might want to treat them before fitting the model. 

Possible options might include deleting the outliers or imputing them. 

This might depend on whether the outlier is due to some error (data entry, sampling, measurement) or whether the outlier is natural. 

##Remus Boxplot
```{r boxplots, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
cancer3 %>% gather() %>%
  ggplot(aes(x = value)) + facet_wrap(~key, scales = "free") +
  geom_boxplot(shape=1, alpha=0.5, col="blue")+
  coord_flip()
```
All four variables have points lying outside the boxes.
Note that PctPrivateCoverage have points lying below the box and
povertyPercent have points lying above the box only.
This shows potential outliers in particular in PctPrivateCoverage and povertyPercent.
Further discoveries and decisions on the outliers should be done when fitting a 
model.

### Multicollinearity
#### Multicollinearity for Married
```{r multicollinearity, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
matrix(cor(cancer2[,c("incidenceRate","PercentMarried","PctMarriedHouseholds","Edu18_24")]), nrow=4, ncol=4)
```
PercentMarried and PctMarriedHouseholds are clearly highly correlated with correlation value 0.87. 

We can further check using Pearson Correlation Coefficient test.
#Correlation Test
```{r cor tests, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
cor.test(cancer2$PercentMarried,cancer2$PctMarriedHouseholds)
```

#### Multicollinearity for Employment

There is strong correlation between PctUnemployed16_over and PctEmployed16_Over. We run a correlation test between these two variables to check to see if there is an yevidence of multi colinearity that should be investigated later.

```{r Multi, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
with(cancer2, cor.test(PctUnemployed16_Over, PctEmployed16_Over))
```

#### Multicollinearity for Poverty
Poverty with PctUnemployed_Over16, PctEmployed_Over16, PctPrivateCoverage, PctEmpPrivCoverage, PctPublicCoverage
```{r cor, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
round(cor(cancer2[,c(5,10:14)])[1,], digits = 2)
```
Correlation is at least 0.65. 
In particular -0.74 with PctEmployed16_Over, -0.82 with PctPrivateCoverage.

Proceed using Pearson Correlation Coefficent test.
We get p-values 2.2e-16 for all five tests.
We can conclude povertyPercent is significant correlated to these five variables.

```{r cor test, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
cor.test(cancer2$povertyPercent, cancer2$PctEmployed16_Over)
cor.test(cancer2$povertyPercent, cancer2$PctUnemployed16_Over)
cor.test(cancer2$povertyPercent, cancer2$PctPrivateCoverage)
cor.test(cancer2$povertyPercent, cancer2$PctEmpPrivCoverage)
cor.test(cancer2$povertyPercent, cancer2$PctPublicCoverage)
```

#### Multicollinearity for Income

```{r Income comparison, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
ggpairs(cancer2, columns = c(3,4), mapping = aes(alpha = 0.6),
        upper = list(continuous=mod_cor),
        lower = list(continuous=wrap(mod_points, col = "red")),
        diag = list(continuous="densityDiag"),
        progress = FALSE) +
        theme(text=element_text(size=6))
```
We can observe that for the first 9 bins medIncome and binnedInc show very similar results. We will therefore consider only using medIncome in our model.

``` {r pearson test age, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
cor.test(cancer2$MedianAgeMale, cancer2$MedianAgeFemale, method = c("pearson"))
```
As the p value is below 0.05 we can assume the correlation is significant and multicollinearity exists between the Median age Male and Median age Female.


### BIG MAP

```{r map, eval = FALSE, echo = FALSE, fig.cap = "\\label{fig:figs}A map showing deathRate accross the United States", fig.width=5, fig.asp=0.68, fig.align="center"}
cancer4 <- cancer2
uwu2 <- str_split(cancer4$Geography, pattern = ", ")
cancer4$state <- rep(0, length(cancer4$Geography))
for(i in 1:length(cancer4$Geography)){
  cancer4$state[i] <- uwu2[[i]][2]
}

cancer4$county <- rep(0, length(cancer4$Geography))
for(i in 1:length(cancer4$Geography)){
  cancer4$county[i] <- uwu2[[i]][1]
}
cancer4$county[159] <- "Dona Ana County"
cancer4$county[775] <- "La Salle Parish"
cancer4$fips <- rep("0", length(cancer4$Geography))
for(i in 1:length(cancer4$Geography)){
  cancer4$fips[i] <- fips(cancer4$state[i], cancer4$county[i])
}
deathMap <- subset(cancer4, select = c("fips", "county", "deathRate"))
plot_usmap(data = deathMap,regions = "counties", values = "deathRate", include = cancer4$fips, color = "red") +
  scale_fill_continuous(low = "yellow", high = "red", name = "Death Rate", label = scales::comma) +
  labs(title = "Death rates in the United States") +
  theme(legend.position = "right")
```

From the map we note that the deathRate appears to be higher in the mid-eastern United States
